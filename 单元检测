import os
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import yaml
from graphviz import Digraph

# ======== é…ç½® ========
OUTPUT_LOGS = "output/logs"  # ä»£ç åå‘³é“æ—¥å¿—ç›®å½•
CONFIG_PATH = "config.yaml"  # é…ç½®æ–‡ä»¶è·¯å¾„
TOOLS_DIR = "tools"  # å·¥å…·ç›®å½•


# ======== å·¥å…·å‡½æ•° ========
def parse_logs():
    """è¯»å– output/logs ä¸­çš„åå‘³é“æ—¥å¿—ï¼Œç»Ÿè®¡æ•°é‡"""
    smell_counts = {}
    if not os.path.isdir(OUTPUT_LOGS):
        print(f"âš  æœªæ‰¾åˆ° {OUTPUT_LOGS} ç›®å½•")
        return smell_counts

    for file in os.listdir(OUTPUT_LOGS):
        if file.endswith(".txt"):
            path = os.path.join(OUTPUT_LOGS, file)
            with open(path, 'r', encoding='utf-8', errors='ignore') as f:
                lines = [line.strip() for line in f if line.strip()]
                smell_counts[file.replace('_logs.txt', '')] = len(lines)
    return smell_counts


def load_config_tools():
    """ä» config.yaml è¯»å–å¯ç”¨çš„å·¥å…·"""
    tools = []
    if not os.path.exists(CONFIG_PATH):
        return tools

    try:
        with open(CONFIG_PATH, 'r', encoding='utf-8') as f:
            cfg = yaml.safe_load(f) or {}
        tools_section = cfg.get('tools', {})
        if isinstance(tools_section, dict):
            for k, v in tools_section.items():
                enabled = True
                if isinstance(v, dict):
                    enabled = v.get('enabled', True)
                elif isinstance(v, bool):
                    enabled = v
                if enabled:
                    tools.append(str(k))
    except Exception as e:
        print(f"è¯»å– config.yaml å‡ºé”™: {e}")
    return tools


def scan_tools_dir():
    """æ‰«æ tools ç›®å½•ä¸­çš„å·¥å…·æ–‡ä»¶å¤¹"""
    if not os.path.isdir(TOOLS_DIR):
        return []
    return sorted([
        d for d in os.listdir(TOOLS_DIR)
        if os.path.isdir(os.path.join(TOOLS_DIR, d)) and not d.startswith('_')
    ])


def ensure_tools(config_tools, dir_tools):
    """ç¡®å®šæœ€ç»ˆå·¥å…·åˆ—è¡¨"""
    if config_tools:
        return sorted(set(config_tools))
    if dir_tools:
        return dir_tools
    return ['pylint', 'pyflakes', 'radon', 'custom_rules']


# ======== å›¾åƒç”Ÿæˆå‡½æ•° ========
def fig13_tool_comparison(tools):
    """ç”Ÿæˆ Fig.13 å·¥å…·å¯¹æ¯”çŸ©é˜µ"""
    # è¿™é‡Œçš„æ•°æ®å¯æŒ‰å®é™…é¡¹ç›®ä¿®æ”¹
    data = {
        'Tool': tools,
        'CLI Support': [True] * len(tools),
        'Output Format': ['Text', 'Text', 'JSON', 'CSV'][:len(tools)],
        'Smell Types Detected': [5, 3, 2, 6][:len(tools)]
    }
    df = pd.DataFrame(data)
    plt.figure(figsize=(6, 3))
    sns.heatmap(df.set_index('Tool').notnull(), annot=True, cbar=False)
    plt.title("Fig.13 Tool Comparison Matrix")
    plt.savefig("fig13_tool_comparison.png", dpi=300)
    plt.close()


def fig14_pipeline(tools):
    """ç”Ÿæˆ Fig.14 æµç¨‹å›¾ï¼ˆGraphviz ç»˜åˆ¶ï¼‰"""
    g = Digraph('Fig14_PyscentPipeline', format='png')
    g.attr(rankdir='LR', splines='ortho', fontname='Microsoft YaHei, Arial', nodesep='0.5', ranksep='1')

    def box(name, label):
        g.node(name, label, shape='box', style='rounded,filled', fillcolor='white')

    # èŠ‚ç‚¹
    box('codebase', 'Target Codebase
    (è¾“å…¥è·¯å¾„)
    ')
    box('config', 'config.yaml + CLI
    (é…ç½®)
    ')
    box('runner', 'Pyscent Runner
    (CodeSmellTool)
    ')
    box('normalizer', 'Unified Parser/Normalizer
    (æ ¼å¼ç»Ÿä¸€)
    ')
    box('aggregator', 'Aggregator
    (åˆå¹¶ / ç»Ÿè®¡)
    ')
    box('export', 'Exporter â†’ output/logs
    (JSON / CSV / TXT)
    ')
    box('viz', 'Visualization â†’ plots
    (Fig
    .15 / 16)')
    box('report', 'Report/Artifacts
    (HTML / Excel / MD)
    ')

    # å·¥å…·é›†ç¾¤
    with g.subgraph(name='cluster_tools') as c:
        c.attr(label='Tool Runners', style='rounded', color='#bbbbbb')
    for i, t in enumerate(tools, 1):
        c.node(f'tool_{i}', t, shape='box', style='rounded,filled', fillcolor='#f5f5f5')

    # è¿çº¿
    g.edge('codebase', 'runner', label='æºç ')
    g.edge('config', 'runner', label='é…ç½®')
    for i, _ in enumerate(tools, 1):
        g.edge('runner', f'tool_{i}', label='æ‰§è¡Œ')
    g.edge(f'tool_{i}', 'normalizer', label='åŸå§‹è¾“å‡º')

    g.edge('normalizer', 'aggregator', label='ç»Ÿä¸€/åˆå¹¶')
    g.edge('aggregator', 'export', label='ç»Ÿè®¡ç»“æœ')
    g.edge('aggregator', 'viz', label='å›¾è¡¨æ•°æ®')
    g.edge('viz', 'report', label='ç”¨äºæŠ¥å‘Š')
    g.edge('export', 'report', style='dashed', label='å¯é€‰å¼•ç”¨')

    g.render(filename='fig14_pipeline', cleanup=True)
    print("âœ… å·²ç”Ÿæˆ fig14_pipeline.png")


def fig15_smell_distribution(smell_counts):
    """ç”Ÿæˆ Fig.15 åå‘³é“åˆ†å¸ƒæŸ±çŠ¶å›¾"""
    labels = list(smell_counts.keys())
    counts = list(smell_counts.values())
    plt.figure(figsize=(8, 4))
    plt.bar(labels, counts, color='skyblue')
    plt.xticks(rotation=45, ha='right')
    plt.ylabel("Number of smells")
    plt.title("Fig.15 Code Smell Distribution")
    plt.tight_layout()
    plt.savefig("fig15_smell_distribution.png", dpi=300)
    plt.close()


def fig16_pie_chart(smell_counts):
    """ç”Ÿæˆ Fig.16 åå‘³é“åˆ†å¸ƒé¥¼å›¾"""
    plt.figure(figsize=(6, 6))
    plt.pie(smell_counts.values(), labels=smell_counts.keys(), autopct='%1.1f%%')
    plt.title("Fig.16 Code Smell Distribution Pie")
    plt.savefig("fig16_smell_distribution_pie.png", dpi=300)
    plt.close()


# ======== ä¸»è¿è¡Œå…¥å£ ========
if __name__ == "__main__":
    smells = parse_logs()
    config_tools = load_config_tools()
    dir_tools = scan_tools_dir()
    tools = ensure_tools(config_tools, dir_tools)

    fig13_tool_comparison(tools)
    fig14_pipeline(tools)
    if smells:
        fig15_smell_distribution(smells)
        fig16_pie_chart(smells)

    print("âœ… å·²ç”Ÿæˆ Fig.13 ~ Fig.16 PNG æ–‡ä»¶")
    print("ğŸ‘‰ Fig.17 ~ Fig.19 è¯·æ’å…¥é¡¹ç›® GitHubã€Excelã€ä¼šè®®è®°å½•æˆªå›¾")
